<h2>Create New Vibe Session</h2>
<form [formGroup]="wizardForm" (ngSubmit)="onSubmit()">
	<mat-form-field appearance="fill">
		<mat-label>Title</mat-label>
		<input matInput formControlName="title" required />
		<mat-error *ngIf="wizardForm.get('title')?.hasError('required')">Title is required</mat-error>
	</mat-form-field>

	<mat-form-field appearance="fill">
		<mat-label>Instructions</mat-label>
		<textarea matInput formControlName="instructions" rows="5" required></textarea>
		<mat-error *ngIf="wizardForm.get('instructions')?.hasError('required')">Instructions are required</mat-error>
	</mat-form-field>

	<!-- Repository Source Selection -->
	<div class="form-field-spacing">
		<mat-label>Repository Source</mat-label>
		<mat-radio-group formControlName="selectedSource" aria-label="Select repository source">
			<mat-radio-button *ngFor="let source of repoSources" [value]="source.value">
				{{ source.label }}
			</mat-radio-button>
		</mat-radio-group>
		<mat-error *ngIf="wizardForm.get('selectedSource')?.hasError('required') && wizardForm.get('selectedSource')?.touched">
			Repository source is required
		</mat-error>
	</div>

	<!-- Repository Selection (Conditional) -->
	<div class="form-field-spacing" [ngSwitch]="selectedSource">
		<!-- Local Repositories -->
		<mat-form-field *ngSwitchCase="'local'" appearance="fill">
			<mat-label>Local Repository Path</mat-label>
			<mat-select formControlName="selectedRepo" required (selectionChange)="onRepoSelectionChange()">
				<mat-option *ngIf="loadingRepos">Loading...</mat-option>
				<mat-option *ngFor="let repoPath of localRepos$ | async" [value]="repoPath">
					{{ repoPath }}
				</mat-option>
				<mat-option *ngIf="!(localRepos$ | async)?.length && !loadingRepos && !repoError" [disabled]="true">
					No local repositories found
				</mat-option>
			</mat-select>
			<mat-error *ngIf="wizardForm.get('selectedRepo')?.hasError('required') && wizardForm.get('selectedRepo')?.touched">
				Local repository path is required
			</mat-error>
			<mat-error *ngIf="repoError">{{ repoError }}</mat-error>
		</mat-form-field>

		<!-- GitHub Repositories -->
		<mat-form-field *ngSwitchCase="'github'" appearance="fill">
			<mat-label>GitHub Repository</mat-label>
			<mat-select formControlName="selectedRepo" required (selectionChange)="onRepoSelectionChange()">
				<mat-option *ngIf="loadingRepos">Loading...</mat-option>
				<mat-option *ngFor="let project of githubProjects" [value]="project.id">
					{{ project.fullPath }}
				</mat-option>
				<mat-option *ngIf="!githubProjects.length && !loadingRepos && !repoError" [disabled]="true">
					No GitHub repositories found
				</mat-option>
			</mat-select>
			<mat-error *ngIf="wizardForm.get('selectedRepo')?.hasError('required') && wizardForm.get('selectedRepo')?.touched">
				GitHub repository is required
			</mat-error>
			<mat-error *ngIf="repoError">{{ repoError }}</mat-error>
		</mat-form-field>

		<!-- GitLab Repositories -->
		<mat-form-field *ngSwitchCase="'gitlab'" appearance="fill">
			<mat-label>GitLab Repository</mat-label>
			<mat-select formControlName="selectedRepo" required (selectionChange)="onRepoSelectionChange()">
				<mat-option *ngIf="loadingRepos">Loading...</mat-option>
				<mat-option *ngFor="let project of gitlabProjects" [value]="project.id">
					{{ project.fullPath }}
				</mat-option>
				<mat-option *ngIf="!gitlabProjects.length && !loadingRepos && !repoError" [disabled]="true">
					No GitLab repositories found
				</mat-option>
			</mat-select>
			<mat-error *ngIf="wizardForm.get('selectedRepo')?.hasError('required') && wizardForm.get('selectedRepo')?.touched">
				GitLab repository is required
			</mat-error>
			<mat-error *ngIf="repoError">{{ repoError }}</mat-error>
		</mat-form-field>
	</div>

	<!-- Branch Selection -->
	<mat-form-field appearance="fill">
		<mat-label>Branch</mat-label>
		<!-- Use input for local, select for SCM -->
		<input *ngIf="selectedSource === 'local'" matInput formControlName="branch" required placeholder="e.g., main, master" />
		<mat-select *ngIf="selectedSource !== 'local'" formControlName="branch" required [disabled]="!wizardForm.get('selectedRepo')?.value || loadingBranches">
			<mat-option *ngIf="loadingBranches">Loading branches...</mat-option>
			<mat-option *ngFor="let branchName of branches$ | async" [value]="branchName">
				{{ branchName }}
			</mat-option>
			<mat-option *ngIf="!(branches$ | async)?.length && !loadingBranches && !branchError && wizardForm.get('selectedRepo')?.value" [disabled]="true">
				No branches found
			</mat-option>
		</mat-select>
		<mat-error *ngIf="wizardForm.get('branch')?.hasError('required') && wizardForm.get('branch')?.touched">Branch is required</mat-error>
		<mat-error *ngIf="branchError">{{ branchError }}</mat-error>
	</mat-form-field>

	<!-- Create New Branch -->
	<div class="form-field-spacing">
		<mat-checkbox formControlName="createNewBranch">Create new branch?</mat-checkbox>
	</div>

	<!-- New Branch Name (Conditional) -->
	<mat-form-field *ngIf="wizardForm.get('createNewBranch')?.value" appearance="fill">
		<mat-label>New Branch Name</mat-label>
		<input matInput formControlName="newBranchName" required />
		<mat-error *ngIf="wizardForm.get('newBranchName')?.hasError('required') && wizardForm.get('newBranchName')?.touched">
			New branch name is required when 'Create new branch?' is checked
		</mat-error>
	</mat-form-field>

	<!-- Use Shared Repos -->
	<div class="form-field-spacing">
		<mat-checkbox formControlName="useSharedRepos">Use Shared Repositories</mat-checkbox>
		<mat-hint>Allow the agent to access repositories shared across users.</mat-hint>
	</div>

	<div class="actions">
		<button mat-raised-button color="primary" type="submit" [disabled]="wizardForm.invalid || isSubmitting">
			{{ isSubmitting ? 'Starting...' : 'Start Vibe Session' }}
		</button>
		<!-- Optional: Add a cancel button -->
		<!-- <button mat-button type="button" [routerLink]="['/vibe']">Cancel</button> -->
	</div>
</form>
