<div class="flex flex-col flex-auto w-full p-6 sm:p-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start justify-between mb-6">
        <div class="text-4xl font-extrabold tracking-tight leading-none">Vibe Session Details</div>
        <!-- Add actions like Edit/Delete later if needed -->
        <!-- <div class="mt-4 sm:mt-0 sm:ml-4">
            <button mat-flat-button [color]="'primary'">
                <mat-icon svgIcon="heroicons_solid:pencil-alt"></mat-icon>
                <span class="ml-2">Edit</span>
            </button>
        </div> -->
    </div>

    <!-- Session Details Card -->
    <ng-container *ngIf="session$ | async as session; else loadingOrError">
        <mat-card class="w-full">
            <mat-card-header>
                <mat-card-title>{{ session.title }}</mat-card-title>
                <mat-card-subtitle>ID: {{ session.id }} | Status: {{ session.status | titlecase }}</mat-card-subtitle>
            </mat-card-header>

            <!-- Status specific messages -->
             <div *ngIf="session.status === 'initializing'" class="p-4 m-4 border rounded bg-blue-50 border-blue-200 text-blue-700">
                <div class="flex items-center">
                    <mat-icon class="mr-2" svgIcon="heroicons_outline:information-circle"></mat-icon>
                    <span>Initializing session, cloning repository and setting up workspace...</span>
                </div>
                <mat-progress-bar mode="indeterminate" class="mt-2"></mat-progress-bar>
            </div>
             <div *ngIf="session.status === 'selecting_files'" class="p-4 m-4 border rounded bg-purple-50 border-purple-200 text-purple-700">
                 <div class="flex items-center">
                    <mat-icon class="mr-2" svgIcon="heroicons_outline:document-search"></mat-icon>
                    <span>Analyzing instructions and selecting relevant files...</span>
                 </div>
                <mat-progress-bar mode="indeterminate" class="mt-2"></mat-progress-bar>
            </div>

            <mat-card-content class="mt-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <div class="font-semibold">Instructions:</div>
                        <p class="text-secondary whitespace-pre-wrap">{{ session.instructions }}</p>
                    </div>
                    <div>
                        <div class="font-semibold">Repository:</div>
                        <p class="text-secondary">
                            Source: {{ session.repositorySource | titlecase }} <br>
                            Identifier: {{ session.repositoryId }} <br>
                            <ng-container *ngIf="session.repositoryName">
                                Name: {{ session.repositoryName }} <br>
                            </ng-container>
                            Branch: {{ session.branch }} <br>
                            <ng-container *ngIf="session.newBranchName">
                                New Branch: {{ session.newBranchName }} <br>
                            </ng-container>
                            Shared Repo: {{ session.useSharedRepos ? 'Yes' : 'No' }}
                        </p>
                    </div>
                    <div>
                        <div class="font-semibold">Created At:</div>
                        <!-- Assuming createdAt is a Firestore Timestamp or Date object -->
                        <p class="text-secondary">{{ session.createdAt?.toDate ? session.createdAt.toDate() : session.createdAt | date:'medium' }}</p>
                    </div>
                    <div>
                        <div class="font-semibold">Last Updated:</div>
                        <p class="text-secondary">{{ session.updatedAt?.toDate ? session.updatedAt.toDate() : session.updatedAt | date:'medium' }}</p>
                    </div>
                    <div *ngIf="session.error" class="sm:col-span-2">
                        <div class="font-semibold text-red-600">Error:</div>
                        <p class="text-red-500 whitespace-pre-wrap">{{ session.error }}</p>
                    </div>

                    <!-- File Selection Review State -->
                    <ng-container *ngIf="currentSession?.status === 'file_selection_review' || currentSession?.status === 'updating_file_selection'">
                        <div class="sm:col-span-2 mt-6 p-4 border rounded bg-yellow-50 border-yellow-200">
                            <h2 class="text-xl font-semibold mb-3 text-yellow-800">Review File Selection</h2>
                            <p class="text-yellow-700 mb-4">Review the files selected by the AI. You can approve the selection to proceed with design generation, or provide instructions to update the selection.</p>

                            <!-- File List (Read-Only in this state) -->
                            <vibe-file-list
                                *ngIf="currentSession?.status === 'file_selection_review' || currentSession?.status === 'updating_file_selection'"
                                [session]="currentSession"
                                [allFiles]="allFiles"
                                [rootNode]="rootNode"
                                (reasonUpdated)="handleReasonUpdated($event)"
                                (categoryUpdated)="handleCategoryUpdated($event)"
                                (addFileRequested)="handleFileAddRequested($event)"
                                (browseFilesRequested)="handleBrowseFilesRequest()"
                                class="mb-4">
                            </vibe-file-list>

                            <!-- Action Buttons -->
                            <div class="flex items-center space-x-2">
                                <button
                                    mat-raised-button
                                    color="primary"
                                    (click)="approveSelection()"
                                    [disabled]="isProcessingAction">
                                    Approve Selection &amp; Generate Design
                                </button>
                                <button
                                    mat-button
                                    (click)="requestSelectionUpdate()"
                                    [disabled]="isProcessingAction">
                                    Update Selection...
                                </button>
                                <mat-spinner *ngIf="isProcessingAction" diameter="24" class="ml-2"></mat-spinner>
                            </div>

                            <div class="mt-6 border-t pt-4"> <!-- Add some visual separation and margin -->
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">Refine File Selection with Instructions:</h3>
                                <mat-form-field class="w-full" appearance="outline">
                                    <mat-label>Instructions to update file selection</mat-label>
                                    <textarea matInput
                                              [formControl]="fileUpdateInstructionsControl"
                                              cdkTextareaAutosize
                                              cdkAutosizeMinRows="3"
                                              cdkAutosizeMaxRows="6"
                                              placeholder="e.g., 'Include all .service.ts files in the user module but exclude the auth.service.ts'"></textarea>
                                </mat-form-field>
                                <div class="flex justify-end mt-2">
                                    <button mat-flat-button
                                            color="primary"
                                            (click)="submitFileUpdateInstructions()"
                                            [disabled]="isProcessingAction || !fileUpdateInstructionsControl.value?.trim()">
                                        Submit Instructions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </ng-container>

                    <!-- File List (Only shown when NOT in file_selection_review state) -->
                    <vibe-file-list
                        *ngIf="currentSession?.status !== 'file_selection_review' && currentSession?.status !== 'initializing' && currentSession?.status !== 'selecting_files' && currentSession?.status !== 'generating_design' && currentSession?.status !== 'coding' && currentSession?.status !== 'committing' && currentSession?.status !== 'monitoring_ci'"
                        [session]="currentSession"
                        [allFiles]="allFiles"
                        [rootNode]="rootNode"
                        (fileDeleted)="handleFileDeleted($event)"
                        (reasonUpdated)="handleReasonUpdated($event)"
                        (categoryUpdated)="handleCategoryUpdated($event)"
                        (addFileRequested)="handleFileAddRequested($event)"
                        (browseFilesRequested)="handleBrowseFilesRequest()"
                        class="sm:col-span-2">
                    </vibe-file-list>

                    <!-- File Autocomplete Input (Only shown when NOT in file_selection_review or initializing states) -->
                    <!-- THIS ENTIRE DIV BLOCK IS REMOVED as its functionality is now in vibe-file-list -->

                    <!-- Use the new VibeDesignProposalComponent -->
                    <vibe-design-proposal
                        *ngIf="session.designAnswer"
                        [session]="session"
                        (designAccepted)="handleDesignAccepted($event)"
                        class="sm:col-span-2">
                    </vibe-design-proposal>

                </div>
            </mat-card-content>
        </mat-card>
    </ng-container>

    <!-- Loading/Error Template -->
    <ng-template #loadingOrError>
        <!-- Check if there was an error fetching (e.g., using catchError in the observable pipe), otherwise show loading -->
        <!-- Basic loading indicator -->
        <div class="flex justify-center items-center h-64">
             <!-- Consider adding error handling display here if session$ errors out -->
            <mat-progress-bar mode="indeterminate" class="w-64"></mat-progress-bar>
            <span class="ml-4 text-secondary">Loading session details...</span>
        </div>
    </ng-template>
</div>
