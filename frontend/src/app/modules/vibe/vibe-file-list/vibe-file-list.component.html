<div class="vibe-file-list-container">
    <ng-container *ngIf="!session?.fileSelection?.length && !isReadOnly; else fileTableOrReadOnlyMessage">
        <p>No files selected.</p>
    </ng-container>

    <ng-template #fileTableOrReadOnlyMessage>
        <ng-container *ngIf="session?.fileSelection?.length; else noFilesSelected">
            <table mat-table [dataSource]="session!.fileSelection!" class="mat-elevation-z8">

                <!-- FilePath Column -->
                <ng-container matColumnDef="filePath">
                    <th mat-header-cell *matHeaderCellDef> File Path </th>
                    <td mat-cell *matCellDef="let file">
                        <div class="file-path-container">
                            <mat-icon *ngIf="file.readOnly" svgIcon="heroicons_outline:lock-closed" matTooltip="Read-only file"></mat-icon>
                            <span>{{ file.filePath }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Reason Column -->
                <ng-container matColumnDef="reason">
                    <th mat-header-cell *matHeaderCellDef> Reason </th>
                    <td mat-cell *matCellDef="let file">
                        <span [class.reason-text-clickable]="!isReadOnly"
                              (click)="!isReadOnly && editReason(file)"
                              [matTooltip]="isReadOnly ? 'Reason editing disabled in current state' : 'Click to edit reason'">
                            {{ file.reason || '-' }}
                        </span>
                    </td>
                </ng-container>

                <!-- Category Column -->
                <ng-container matColumnDef="category">
                    <th mat-header-cell *matHeaderCellDef> Category </th>
                    <td mat-cell *matCellDef="let file">
                        <div (click)="$event.stopPropagation()"> <!-- Prevent row click if any -->
                            <span *ngIf="editingCategoryFilePath !== file.filePath; else categorySelect"
                                  [class.category-text-clickable]="!isReadOnly"
                                  (click)="!isReadOnly && toggleCategoryEdit(file, $event)"
                                  [matTooltip]="isReadOnly ? 'Category editing disabled in current state' : 'Click to edit category'">
                                {{ file.category || '-' }}
                            </span>
                            <ng-template #categorySelect>
                                <mat-select [value]="file.category"
                                            (selectionChange)="onCategoryChange(file, $event.value)"
                                            (openedChange)="$event ? null : cancelCategoryEdit()"
                                            placeholder="Select category">
                                    <mat-option *ngFor="let cat of availableCategories" [value]="cat">
                                        {{ cat | titlecase }}
                                    </mat-option>
                                </mat-select>
                            </ng-template>
                        </div>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> Actions </th>
                    <td mat-cell *matCellDef="let file">
                        <button mat-icon-button
                                [disabled]="isReadOnly || file.readOnly"
                                [matTooltip]="isReadOnly ? 'Deletion disabled: Session is in read-only review state.' : (file.readOnly ? 'Deletion disabled: File is read-only.' : 'Remove file')"
                                (click)="deleteFile(file)">
                            <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
        </ng-container>
        <ng-template #noFilesSelected>
            <p *ngIf="isReadOnly && !session?.fileSelection?.length">File selection is currently under AI review. No files have been selected yet or the list is being updated.</p>
            <p *ngIf="!isReadOnly && !session?.fileSelection?.length">No files selected.</p>
        </ng-template>
    </ng-template>

    <!-- Add/Browse Files Section - Conditionally shown based on isReadOnly -->
    <div *ngIf="!isReadOnly" class="my-6 p-4 border rounded bg-gray-50 border-gray-200">
        <h3 class="text-lg font-semibold text-gray-700 mb-3">Add or Browse Files</h3>
        <div class="flex items-center space-x-2">
            <mat-form-field class="flex-grow" appearance="outline">
               <mat-label>Search and add file path</mat-label>
               <input type="text" matInput placeholder="e.g., src/app/my-component.ts"
                      [formControl]="addFileControl" [matAutocomplete]="autoFileAdd">
               <mat-autocomplete #autoFileAdd="matAutocomplete">
                   <mat-option *ngFor="let file of filteredFiles$ | async" [value]="file">
                       {{ file }}
                   </mat-option>
               </mat-autocomplete>
           </mat-form-field>
           <button mat-stroked-button color="primary" [disabled]="!addFileControl.value?.trim()" (click)="onHandleAddFile()">
               <mat-icon svgIcon="heroicons_outline:plus-circle" class="mr-1"></mat-icon> Add
           </button>
        </div>
        <div class="mt-3 flex justify-end">
           <button mat-stroked-button (click)="onBrowseFiles()" type="button">
               <mat-icon svgIcon="heroicons_outline:folder-open" class="mr-2"></mat-icon>
               Browse All Files
           </button>
       </div>
   </div>

   <!-- Original table structure for reference if needed, or to be placed within the #fileTable template -->
   <!--
    <ng-template #fileTable>
        <table mat-table [dataSource]="session!.fileSelection!" class="mat-elevation-z8">
   -->
            <!-- FilePath Column -->
            <ng-container matColumnDef="filePath">
                <th mat-header-cell *matHeaderCellDef> File Path </th>
                <td mat-cell *matCellDef="let file">
                    <div class="file-path-container">
                        <mat-icon *ngIf="file.readOnly" svgIcon="heroicons_outline:lock-closed" matTooltip="Read-only file"></mat-icon>
                        <span>{{ file.filePath }}</span>
                    </div>
                </td>
            </ng-container>

            <!-- Reason Column -->
            <ng-container matColumnDef="reason">
                <th mat-header-cell *matHeaderCellDef> Reason </th>
                <td mat-cell *matCellDef="let file">
                    <span [class.reason-text-clickable]="!isReadOnly"
                          (click)="!isReadOnly && editReason(file)"
                          [matTooltip]="isReadOnly ? 'Reason editing disabled in current state' : 'Click to edit reason'">
                        {{ file.reason || '-' }}
                    </span>
                </td>
            </ng-container>

            <!-- Category Column -->
            <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef> Category </th>
                <td mat-cell *matCellDef="let file">
                    <div (click)="$event.stopPropagation()"> <!-- Prevent row click if any -->
                        <span *ngIf="editingCategoryFilePath !== file.filePath; else categorySelect"
                              [class.category-text-clickable]="!isReadOnly"
                              (click)="!isReadOnly && toggleCategoryEdit(file, $event)"
                              [matTooltip]="isReadOnly ? 'Category editing disabled in current state' : 'Click to edit category'">
                            {{ file.category || '-' }}
                        </span>
                        <ng-template #categorySelect>
                            <mat-select [value]="file.category"
                                        (selectionChange)="onCategoryChange(file, $event.value)"
                                        (openedChange)="$event ? null : cancelCategoryEdit()"
                                        placeholder="Select category">
                                <mat-option *ngFor="let cat of availableCategories" [value]="cat">
                                    {{ cat | titlecase }}
                                </mat-option>
                            </mat-select>
                        </ng-template>
                    </div>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Actions </th>
                <td mat-cell *matCellDef="let file">
                    <button mat-icon-button
                            [disabled]="isReadOnly || file.readOnly"
                            [matTooltip]="isReadOnly ? 'Deletion disabled: Session is in read-only review state.' : (file.readOnly ? 'Deletion disabled: File is read-only.' : 'Remove file')"
                            (click)="deleteFile(file)">
                        <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
    </ng-template>

            <!-- FilePath Column -->
            <ng-container matColumnDef="filePath">
                <th mat-header-cell *matHeaderCellDef> File Path </th>
                <td mat-cell *matCellDef="let file">
                    <div class="file-path-container">
                        <mat-icon *ngIf="file.readOnly" svgIcon="heroicons_outline:lock-closed" matTooltip="Read-only file"></mat-icon>
                        <span>{{ file.filePath }}</span>
                    </div>
                </td>
            </ng-container>

            <!-- Reason Column -->
            <ng-container matColumnDef="reason">
                <th mat-header-cell *matHeaderCellDef> Reason </th>
                <td mat-cell *matCellDef="let file">
                    <span [class.reason-text-clickable]="!isReadOnly"
                          (click)="!isReadOnly && editReason(file)"
                          [matTooltip]="isReadOnly ? 'Reason editing disabled in current state' : 'Click to edit reason'">
                        {{ file.reason || '-' }}
                    </span>
                </td>
            </ng-container>

            <!-- Category Column -->
            <ng-container matColumnDef="category">
                <th mat-header-cell *matHeaderCellDef> Category </th>
                <td mat-cell *matCellDef="let file">
                    <div (click)="$event.stopPropagation()"> <!-- Prevent row click if any -->
                        <span *ngIf="editingCategoryFilePath !== file.filePath; else categorySelect"
                              [class.category-text-clickable]="!isReadOnly"
                              (click)="!isReadOnly && toggleCategoryEdit(file, $event)"
                              [matTooltip]="isReadOnly ? 'Category editing disabled in current state' : 'Click to edit category'">
                            {{ file.category || '-' }}
                        </span>
                        <ng-template #categorySelect>
                            <mat-select [value]="file.category"
                                        (selectionChange)="onCategoryChange(file, $event.value)"
                                        (openedChange)="$event ? null : cancelCategoryEdit()"
                                        placeholder="Select category">
                                <mat-option *ngFor="let cat of availableCategories" [value]="cat">
                                    {{ cat | titlecase }}
                                </mat-option>
                            </mat-select>
                        </ng-template>
                    </div>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef> Actions </th>
                <td mat-cell *matCellDef="let file">
                    <button mat-icon-button
                            [disabled]="isReadOnly || file.readOnly"
                            [matTooltip]="isReadOnly ? 'Deletion disabled: Session is in read-only review state.' : (file.readOnly ? 'Deletion disabled: File is read-only.' : 'Remove file')"
                            (click)="deleteFile(file)">
                        <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
                    </button>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
    </ng-template>
</div>
