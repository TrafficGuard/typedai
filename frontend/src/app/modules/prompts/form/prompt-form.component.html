<div class="flex flex-col flex-auto w-full p-4 sm:p-4" xmlns="http://www.w3.org/1999/html">
    <div class="flex items-center justify-between mb-4 mx-3">
        <h1 class="text-3xl font-medium tracking-tight leading-none">Prompt Studio</h1>
        <button mat-stroked-button (click)="goBack()" type="button">
            <mat-icon svgIcon="heroicons_outline:arrow-left"></mat-icon>
            <span class="ml-2">Back</span>
        </button>
    </div>

    <div class="bg-card rounded-lg shadow p-4">
        <div *ngIf="isLoading()" class="flex flex-auto justify-center items-center p-8">
            <mat-spinner diameter="50"></mat-spinner>
        </div>

        <ng-container *ngIf="!isLoading()">

            <form [formGroup]="promptForm" (ngSubmit)="onSubmit()" class="space-y-6 flex-auto flex flex-col">
                <div class="flex-auto space-y-6 pr-2">

                    <mat-accordion>
                        <mat-expansion-panel class="mb-1 !shadow-sm border" #detailsPanel>
                            <mat-expansion-panel-header>
                                <mat-panel-title class="!text-sm !font-semibold">
                                    Prompt Details:
                                    <!-- Display summary based on panel expansion state -->
                                    <ng-container>
                              <span [@summaryFade]="detailsPanel.expanded ? 'hidden' : 'visible'">
                                  <span class="ml-2">{{ promptForm.get('name')?.value || 'N/A' }}</span>
                                  <mat-chip-listbox *ngIf="tagsFormArray.controls.length > 0" aria-label="Prompt tags" class="inline-flex flex-wrap gap-1 ml-3">
                                     <mat-chip *ngFor="let tagControl of tagsFormArray.controls; let i = index"
                                               class="text-xs !h-5 !min-h-[20px] !px-2 !py-0.5 !m-0 ml-2"
                                               disabled="true" color="accent" selected> <!-- Static look -->
                                         {{tagControl.value}}
                                     </mat-chip>
                                  </mat-chip-listbox>
                              </span>

                                    </ng-container>
                                </mat-panel-title>
                            </mat-expansion-panel-header>

                            <!-- Content of the expansion panel -->
                            <mat-form-field class="w-full">
                                <mat-label>Name</mat-label>
                                <input matInput formControlName="name" required>
                                <mat-error *ngIf="promptForm.get('name')?.hasError('required')">Name is required.</mat-error>
                            </mat-form-field>

                            <mat-form-field class="w-full">
                                <mat-label>Tags</mat-label>
                                <mat-chip-grid #chipGrid aria-label="Enter tags" formArrayName="tags">
                                    <mat-chip-row *ngFor="let tagControl of tagsFormArray.controls; let i = index" (removed)="removeTagAtIndex(i)" [editable]="true" [removable]="true">
                                        {{tagControl.value}}
                                        <button matChipRemove [attr.aria-label]="'remove ' + tagControl.value">
                                            <mat-icon>cancel</mat-icon>
                                        </button>
                                    </mat-chip-row>
                                </mat-chip-grid>
                                <input placeholder="New tag..."
                                       [formControl]="tagCtrl"
                                       [matChipInputFor]="chipGrid"
                                       [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                                       [matChipInputAddOnBlur]="true"
                                       (matChipInputTokenEnd)="addTagFromInput($event)"/>
                            </mat-form-field>
                        </mat-expansion-panel>
                    </mat-accordion>

                    <!-- Messages Section -->
                    <div class="space-y-4"> <!-- Container for the messages section -->
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-semibold pb-4">
                                Messages
                                <mat-slide-toggle  class="ml-6"><!-- formControlName="includeSystemMessage" -->
                                    Include System Message
                                </mat-slide-toggle>
                            </h3>
                            <button mat-icon-button type="button" (click)="addMessage()" matTooltip="Add Message">
                                <mat-icon svgIcon="heroicons_outline:plus-circle"></mat-icon>
                            </button>
                        </div>

                        <div *ngIf="messagesFormArray.controls.length === 0" class="text-center text-gray-500 py-4 border rounded-md bg-gray-50 dark:bg-gray-800">
                            No messages yet. Click the '+' button to add one.
                            <mat-error *ngIf="promptForm.get('messages')?.hasError('minlength') && promptForm.get('messages')?.touched" class="block mt-1">At least one message is required.</mat-error>
                        </div>

                        <mat-accordion multi="true" *ngIf="messagesFormArray.controls.length > 0" formArrayName="messages">
                            <mat-expansion-panel *ngFor="let msgGroup of messagesFormArray.controls; let i = index" [formGroupName]="i" class="mb-2 !shadow-sm border dark:border-gray-700 bg-white dark:bg-gray-850 rounded-md overflow-hidden" #messagePanel="matExpansionPanel">
                                <mat-expansion-panel-header>
                                    <!-- Display summary based on panel expansion state -->
                                    <mat-panel-title class="!text-sm !font-semibold">
                                        <span [@summaryFade]="messagePanel.expanded ? 'hidden' : 'visible'">
                                            {{ msgGroup.get('role')?.value | titlecase }}
                                            <span *ngIf="msgGroup.get('content')?.value" class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2 truncate">
                                                - {{ (msgGroup.get('content')?.value || '') | slice:0:50 }}{{ (msgGroup.get('content')?.value?.length || 0) > 50 ? '...' : '' }}
                                            </span>
                                            <span *ngIf="!msgGroup.get('content')?.value" class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2 italic">
                                                - No content
                                            </span>
                                        </span>
                                    </mat-panel-title>
                                </mat-expansion-panel-header>

                                <!-- Content of the expansion panel (form fields) -->
                                <div class="pr-4  dark:border-gray-700 space-y-4" [ngClass]="{'pt-0': messagePanel.expanded, '-mt-8': messagePanel.expanded}">

                                    <mat-form-field class="w-full">
                                        <textarea matInput formControlName="content" cdkTextareaAutosize cdkAutosizeMinRows="3" required></textarea>
                                        <mat-error *ngIf="msgGroup.get('content')?.hasError('required')">Content is required.</mat-error>
                                    </mat-form-field>

                                    <button mat-icon-button type="button" (click)="removeMessage(i)" matTooltip="Remove Message" class="ml-2 pt-4 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400">
                                        <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
                                    </button>

                                    <div class="text-sm text-gray-500 dark:text-gray-400 message-tokens-display">
                                        Tokens: N/A
                                    </div>
                                </div>
                            </mat-expansion-panel>
                        </mat-accordion>
                    </div>

                    <!-- Generation Options Card - uses toggleOptions() and optionsCollapsed() -->

                    <div class="flex justify-between items-center">
                        <h4 class="text-xl font-semibold pb-4">
                            Generation Options
                        </h4>
                    </div>


                        <!-- Content for Generation Options already wrapped with *ngIf="!optionsCollapsed()" -->
                        <div class="parameters-section" formGroupName="options" *ngIf="!optionsCollapsed()">
                            <div class="flex flex-row gap-4"> <!-- Flex container for horizontal layout -->
                                <div class="parameter-item flex-1"> <!-- flex-1 to allow items to grow and share space -->
                                    <mat-form-field appearance="outline" class="model-selector w-full">
                                        <mat-label>Model</mat-label>
                                        <mat-select formControlName="llmId"> <!-- Changed from selectedModel -->
                                            <mat-option *ngFor="let model of availableModels" [value]="model.id">{{ model.name }}</mat-option>
                                        </mat-select>
                                        <mat-error *ngIf="promptForm.get('options.llmId')?.hasError('required')">Model is required.</mat-error> <!-- Changed from options.selectedModel -->
                                    </mat-form-field>
                                </div>

                                <div class="parameter-item flex-1"> <!-- flex-1 to allow items to grow and share space -->
                                    <label id="temperature-label" class="parameter-label">Temperature</label>
                                    <div class="slider-input-group">
                                        <mat-slider min="0" max="2" step="0.1" discrete="true"
                                                    [value]="promptForm.get('options.temperature')?.value"
                                                    (input)="promptForm.get('options.temperature')?.setValue($event.value)"
                                                    aria-labelledby="temperature-label"
                                                    class="parameter-slider">
                                            <input matSliderThumb>
                                        </mat-slider>
                                        <mat-form-field appearance="outline" class="parameter-input">
                                            <input matInput type="number" formControlName="temperature" min="0" max="2" step="0.1">
                                        </mat-form-field>
                                    </div>
                                </div>

                                <div class="parameter-item flex-1"> <!-- flex-1 to allow items to grow and share space -->
                                    <label id="maxOutputTokens-label" class="parameter-label">Max Tokens</label>
                                    <div class="slider-input-group">
                                        <mat-slider min="1" max="8192" step="1" discrete="true"
                                                    [value]="promptForm.get('options.maxOutputTokens')?.value"
                                                    (input)="promptForm.get('options.maxOutputTokens')?.setValue($event.value)"
                                                    aria-labelledby="maxOutputTokens-label"
                                                    class="parameter-slider">
                                            <input matSliderThumb>
                                        </mat-slider>
                                        <mat-form-field appearance="outline" class="parameter-input">
                                            <input matInput type="number" formControlName="maxOutputTokens" min="1" max="8192" step="1">
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>

                <div class="flex justify-end gap-2 pt-4 mt-auto border-gray-200 dark:border-gray-700">
                    <button mat-stroked-button type="button" (click)="goBack()" [disabled]="isSaving()">Cancel</button>
                    <button mat-flat-button color="primary" type="submit" [disabled]="isSaving() || promptForm.invalid" class="submit-button">
                        <mat-spinner *ngIf="isSaving()" diameter="20" class="!text-white mr-2"></mat-spinner>
                        <span>{{ isSaving() ? 'Saving...' : (isEditMode() ? 'Save Changes' : 'Create Prompt') }}</span>

                        <!--
                      <mat-chip-listbox aria-label="Submit shortcut" class="ml-2 shrink-0" *ngIf="!isSaving()">
                        <mat-chip selectable="false" focusable="false" class="submit-shortcut-chip">
                          <mat-icon svgIcon="heroicons_outline:command-line" class="icon-xs"></mat-icon>
                          <span class="mx-px font-mono">+</span>
                          <mat-icon svgIcon="heroicons_outline:arrow-uturn-left" class="icon-xs"></mat-icon>
                        </mat-chip>
                      </mat-chip-listbox>
                        -->
                    </button>
                </div>
            </form>
        </ng-container>
    </div>
</div>
