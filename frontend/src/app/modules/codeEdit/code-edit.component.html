<div class="code-edit-container">
    <as-split direction="horizontal" unit="percent">
        <as-split-area *ngIf="showFilePanels()" [size]="25" [minSize]="20" [maxSize]="50">
            <div class="panel-content">
                <h3 class="text-lg font-semibold mb-2">File Tree</h3>
                @switch (treeState().status) {
                    @case ('loading') {
                        <div class="flex items-center justify-center h-full">
                            <mat-spinner diameter="40"></mat-spinner>
                        </div>
                    }
                    @case ('error') {
                        <div class="text-red-500 p-4">
                            <p>Error loading file tree:</p>
                            <p class="text-sm">{{ treeState().error?.message }}</p>
                            <button mat-button color="warn" (click)="codeEditService.getFileSystemTree()">Retry</button>
                        </div>
                    }
                    @case ('success') {
                        <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="file-tree">
                            <!-- Node with children (directory) -->
                            <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
                                <div class="mat-tree-node" [class.selected]="isIndeterminate(node) || isFileOrAncestorSelected(node)">
                                    <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'Toggle ' + node.name">
                                        <mat-icon class="mat-icon-rtl-mirror">
                                            {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
                                        </mat-icon>
                                    </button>
                                    <mat-checkbox 
                                        class="node-checkbox"
                                        [checked]="isFileOrAncestorSelected(node)" 
                                        [indeterminate]="isIndeterminate(node)"
                                        (change)="toggleNodeSelection(node)"
                                        (click)="$event.stopPropagation()">
                                    </mat-checkbox>
                                    <mat-icon>folder</mat-icon>
                                    <span class="node-name">{{node.name}}</span>
                                </div>
                                <div [class.tree-node-container-invisible]="!treeControl.isExpanded(node)">
                                    <ng-container matTreeNodeOutlet></ng-container>
                                </div>
                            </mat-nested-tree-node>
                            <!-- Leaf node (file) -->
                            <mat-tree-node *matTreeNodeDef="let node">
                                <div class="mat-tree-node leaf-node" [class.selected]="isFileOrAncestorSelected(node)">
                                    <div class="mat-tree-node-toggle-placeholder"></div>
                                    <mat-checkbox 
                                        class="node-checkbox"
                                        [checked]="isFileOrAncestorSelected(node)"
                                        (change)="toggleNodeSelection(node)"
                                        (click)="$event.stopPropagation()">
                                    </mat-checkbox>
                                    <mat-icon>insert_drive_file</mat-icon>
                                    <span class="node-name">{{node.name}}</span>
                                </div>
                            </mat-tree-node>
                        </mat-tree>
                    }
                    @case ('not_found') {
                        <p class="p-4 text-gray-500">File tree could not be found.</p>
                    }
                    @case ('idle') {
                        <!-- Initial state before loading begins -->
                    }
                }
            </div>
        </as-split-area>
        <as-split-area>
            <as-split direction="vertical" unit="percent">
                <as-split-area [size]="60">
                     <div class="panel-content">
                        <h3 class="text-lg font-semibold mb-2">Selected Files ({{ selectedFiles().length }})</h3>
                        
                        @if (selectedFiles().length === 0) {
                            <div class="flex items-center justify-center h-full text-gray-500">
                                <p>Select files from the tree on the left.</p>
                            </div>
                        } @else {
                            <div class="table-container">
                                <table mat-table [dataSource]="selectionDataSource" class="selection-table">
                                    <!-- Path Column -->
                                    <ng-container matColumnDef="path">
                                        <th mat-header-cell *matHeaderCellDef> File Path </th>
                                        <td mat-cell *matCellDef="let filePath" [matTooltip]="filePath"> {{filePath}} </td>
                                    </ng-container>

                                    <!-- Actions Column -->
                                    <ng-container matColumnDef="actions">
                                        <th mat-header-cell *matHeaderCellDef></th>
                                        <td mat-cell *matCellDef="let filePath">
                                            <button mat-icon-button color="warn" (click)="removeFileFromSelection(filePath)" [attr.aria-label]="'Remove ' + filePath">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </ng-container>

                                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                                </table>
                            </div>
                        }
                    </div>
                </as-split-area>
                <as-split-area [size]="40">
                    <div class="panel-content">
                        <h3 class="text-lg font-semibold mb-2">Instructions</h3>
                        <form [formGroup]="instructionForm" (ngSubmit)="onSubmit()" class="flex flex-col h-full">
                            <textarea
                                formControlName="instructions"
                                class="w-full flex-grow border rounded-md p-2"
                                placeholder="Enter your code editing instructions here..."></textarea>
                            
                            @if (submissionError(); as error) {
                                <div class="text-red-500 text-sm my-2">
                                    {{ error }}
                                </div>
                            }

                            <button
                                type="submit"
                                class="mt-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark flex items-center justify-center"
                                [disabled]="instructionForm.invalid || isSubmitting()">
                                @if (isSubmitting()) {
                                    <mat-spinner diameter="20" class="mr-2"></mat-spinner>
                                    <span>Submitting...</span>
                                } @else {
                                    <span>Submit</span>
                                }
                            </button>
                        </form>
                    </div>
                </as-split-area>
            </as-split>
        </as-split-area>
    </as-split>
</div>
