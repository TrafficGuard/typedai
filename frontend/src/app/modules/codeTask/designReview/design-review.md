# Design Review Page

**Goal:** Allow users to review a design generated by the AI, and either 
- Manually modify
- Give instructions to modify
- Approve the design

## Parent Component Route
/codeTask/:codeTaskId
frontend/src/app/modules/codeTask/codeTask.component.ts is responsible for checking the state of the CodeTask and displaying the appropriate sub-component.
When the status (CodeTaskStatus in codeTask.model.ts) is `design_review` or `updating_design` then codeTask.component.html will display the code-task-design-review component.

# code-task-file-list.component functionality

## OnLoad
- Fetch the CodeTask data
- Fetch the repository file tree

## Code Task File List UI

### Main screen

Design[tab]  Files[tab]


(Save)[button]               (Reset Selection)[button]

(Implement Design)[button]

#### Design tab

Design
[markdown rendered|textarea]

(Edit)[button] | (Save)[button] (Cancel)[button]

Update design instructions
[textarea]
(submit)[button]

#### Files tab

Selected files [table]
|| Path | Reason | Category | Delete ||

Search files [textfield] (Add)[button]

(Show files)[link]

== form
File Selection Update Instructions
[textarea]

(Submit)[button]
==


### Show files screen

Filter [textarea]

Files[tree]

(Cancel)[button] Select[button]

## Notes

On the main screen
- If the user click on a reason in the table it will show a modal dialog with the reason text to edit.
- If the user click on a category in the table it will switch the text to a dropdown. If a value is selected or the user clicks out of the dropdown then it goes back to just text

When the user types in the Search files text field it will autocomplete and in the autocomplete preview list show a selection (upto 10)
The autocomplete matching should match on prefixes of snake or camel case, or dot, dash or underscore seperators.
For example if the file list includes the name
fileSelection.ts
then if the user has typed vf, vfl or vflc then it should match

When the user clicks on the Show files link the component will display only the whole the repository file system tree in a selectable list
The filter textarea will filter the list with the same filename part prefix matching rules as the Search files autocomplete
The Select button will close the file system overlay add the files to selection list showing table (without saving)

The File Selection Update Instructions form is submitted, or the save buttons are clicked there will be a spinner overlay preventing actions while the submission is in progress.


Display the selected files list
**Display Selected Files:**
*   Use `MatTable` to display `codeTask.fileSelection`.
*   Columns: File Path (`filePath`), Reason (`reason`), Category (`category`), Actions (e.g., Remove button). (Ref: `codeTask.types.ts::SelectedFile`).
*   The `category` field from `selectFilesAgent.ts` should be populated by the agent.
**Add Files:**
*   Use `MatFormField` with `MatAutocomplete`.
*   Input source for autocomplete should be the list of all file paths derived from the fetched file tree (`FileSystemNode[]`). Implement filtering as the user types.
*   On selection, add the file path to a temporary list or directly update the codeTask via PATCH. If updating directly, refetch codeTask data. Consider requiring a reason/category upon adding.
*   **Remove Files:** Clicking the remove button next to a file in the table should update the `codeTask.fileSelection` via `PATCH /api/codeTask/:codeTaskId`. Refetch codeTask data.
*   **Refine Selection with Prompt:**
    *   Provide a `MatInput` (textarea) for the user to enter a refinement prompt.
    *   Add a "Refine Selection" button. Clicking it calls a new method in `codeTaskService.ts` (frontend) which hits `POST /api/codeTask/:codeTaskId/update-selection` with the prompt.
    *   The UI should indicate processing (e.g., disable buttons, show spinner) and poll for status change back to `file_selection_review` or `error_file_selection`.
*   **Generate Detailed Design:**
    *   Provide a `MatFormField` with `MatSelect` for choosing the number of design variations (e.g., 1 to 3). Default to 1.
    *   Add a "Generate Detailed Design" button. Clicking it calls a new method in `codeTaskService.ts` (frontend) which hits `POST /api/codeTask/:codeTaskId/generate-design` with the selected variation count.
    *   The UI should navigate to the Detailed Design Review page (`/codeTask/design-review/:codeTaskId`) or an intermediate loading page while the design is generated.
*   **State Management:** Disable/enable UI elements based on `codeTask.status`. For example, disable "Generate Detailed Design" if status is `updating_selection`.


Okay, I've reviewed the user stories methodically. Here's an improved version incorporating your feedback and further refinements for cohesion, validity, clarity, and to catch potential missing pieces.

**Key Changes:**

*   **Merged Section I:** Combined the general table display with details of what's in each row.
*   **Consistent Terminology:** Used "notification" for transient messages (like snackbars) and "message" for more static on-screen text.
*   **Clarity on "System State":** Used phrases like "When the system allows modifications" or "When the system is in a read-only review state" to abstract away `AgentContext` specifics while still conveying the necessary conditions.
*   **User Focus:** Ensured each story focuses on what the user wants to do or see and the direct outcome.
*   **Added Implicit States:** Some stories now more clearly imply the starting state (e.g., "When the file list is displayed...").

---

**User Stories: File Selection Review**

**I. Viewing the File Selection List**

1.  **Initial Page Load - No Files Selected:**
    *   When I navigate to the file selection review page, if no files are currently part of the selection and the system is not actively updating the list, I want to see a message like "No files selected."
2.  **Initial Page Load - System Updating:**
    *   When I navigate to the file selection review page, if the system is currently in the process of updating the file selection (e.g., an AI is revising it), I want to see a message indicating that "File selection is currently under AI review. No files have been selected yet or the list is being updated."
    *   During this time, I expect interactive elements for modifying the list to be disabled.
3.  **Viewing the List of Selected Files:**
    *   When files are part of the current selection, I want to see them displayed in a table.
    *   This table should clearly show each file's:
        *   "Path" (its location in the project).
        *   "Reason" for its inclusion in the selection.
        *   "Category" (e.g., "edit," "reference").
        *   An "Actions" column for managing individual files.
    *   For each file displayed in the list:
        *   If a file is designated by the system as "read-only" (meaning I cannot remove it from the selection):
            *   I want to see a visual indicator (e.g., a lock icon) next to its path.
            *   I want a tooltip to appear if I hover over this indicator, explaining it's a "Read-only file."
        *   If a file's "Reason" is not specified, I want to see a placeholder (e.g., "-") in that column.
        *   If a file's "Category" is not specified, I want to see a placeholder (e.g., "-") in that column.

**II. Modifying Individual Files in the List**

*(These stories apply when the system allows user modifications to the file selection list.)*

4.  **Editing a File's Reason:**
    *   I want the "Reason" text for each modifiable file in the list to be clickable, with a tooltip like "Click to edit reason."
    *   When I click on a file's reason:
        *   I want a dialog to open where I can edit the text of the reason.
        *   This dialog should clearly indicate which file's reason I am editing (e.g., by showing its path) and pre-fill the current reason and category.
        *   After I save my changes in the dialog:
            *   I want the reason (and category, if also changed in the dialog) for that file to update in the list on my screen.
            *   I want to receive a notification that my changes are local and I need to perform a "Save File Selection Changes" action to make them permanent for the review.
5.  **Editing a File's Category (Inline):**
    *   I want the "Category" text for each modifiable file in the list to be clickable, with a tooltip like "Click to edit category."
    *   When I click on a file's category:
        *   I want the text to change into a dropdown menu, pre-selected with the file's current category.
        *   The dropdown should offer a predefined list of relevant categories (e.g., "edit," "reference," "style example," "unknown").
        *   When I select a new category from the dropdown:
            *   I want the category for that file to update in the list on my screen.
            *   I want the dropdown to revert to displaying the newly selected category as text.
            *   I want to receive a notification that my changes are local and I need to perform a "Save File Selection Changes" action.
        *   If I click away from the open category dropdown without making a new selection, I want it to revert to displaying the original category as text.
6.  **Removing a File from the List:**
    *   For each file in the list that is not system-designated as "read-only":
        *   I want to see a "Remove" button (e.g., a trash icon) in its "Actions" column, with a tooltip like "Remove file."
        *   When I click this "Remove" button:
            *   I want the file to disappear from the list on my screen.
            *   I want to receive a notification that the file was removed locally and I need to perform a "Save File Selection Changes" action.
    *   For files that are system-designated as "read-only":
        *   I want their "Remove" button to be disabled, with a tooltip like "Deletion disabled: File is read-only."
7.  **Attempting Modifications in a Read-Only State:**
    *   When the system is in a read-only review state (e.g., AI is updating the selection):
        *   I do not want to be able to click a file's reason or category to edit them. Tooltips should indicate "Editing disabled in current state."
        *   I want all "Remove" buttons in the list to be disabled, with a tooltip like "Deletion disabled: System is updating."

**III. Adding New Files to the Selection**

*(These stories apply when the system allows user modifications to the file selection list.)*

8.  **Accessing File Addition Tools:**
    *   I want to see a dedicated section or set of tools to "Add or Browse Files." This section should not be visible if the system is in a read-only review state.
9.  **Searching and Adding a File by Path:**
    *   Within the file addition section, I want an input field labeled "Search and add file path."
    *   As I type in this field, I want to see a list of suggestions auto-completing from available project files.
    *   I want an "Add" button associated with this input field, which is disabled if the input field is empty.
    *   When I enter a file path (or select one from autocomplete) and click "Add":
        *   If the file path is already in my current selection list, I want to receive a notification stating that.
        *   Otherwise, I want a dialog to appear, prompting me to provide a "Reason" and select a "Category" for this newly added file (pre-filled with the path).
        *   After I confirm this dialog:
            *   I want the new file to appear in my selection list on screen.
            *   I want to receive a notification that the file was added locally and I need to perform a "Save File Selection Changes" action.
            *   I want the "Search and add file path" input field to be cleared.
10. **Browsing Project Files to Add:**
    *   Within the file addition section, I want a button labeled "Browse All Files."
    *   When I click "Browse All Files":
        *   If the project's file structure is not yet available for browsing, I want a notification indicating this.
        *   Otherwise, I want a dialog to open displaying a navigable tree or list of all files in my project.
        *   I want to be able to select one or more files from this browser.
        *   When I confirm my selections in the browser dialog:
            *   For each newly selected file that isn't already in my list, I want it to be added to my selection list on screen (with a default reason/category, or prompting for them).
            *   I want a notification summarizing how many new files were added and reminding me to perform a "Save File Selection Changes" action.
            *   If I selected files that were already in my list, or no new files were chosen, I want an appropriate notification.

**IV. Reviewing and Finalizing the File Selection**

*(These stories apply when the system indicates the file selection is ready for user review and final actions, e.g., `status === 'file_selection_review'`.)*

11. **Accessing Review Actions:**
    *   When the file selection is ready for my review, I want to see a clear section for "Refine File Selection with Instructions" and another for "Final Actions." These sections should not be visible otherwise.
12. **Refining Selection with Instructions:**
    *   I want a multi-line text area labeled "Instructions to update file selection" (or similar).
    *   I want a "Submit Instructions" button associated with this text area.
        *   This button should be disabled if I haven't entered any text or if another review action is already processing.
        *   When I enter instructions and click "Submit Instructions":
            *   I want to see a visual indicator that my request is being processed.
            *   I want to receive a notification that my "Update request sent. The file selection will be revised."
            *   I want the text area to be cleared after successful submission.
            *   If there's an error submitting, I want an error notification.
13. **Saving Local Changes to the Selection:**
    *   In the "Final Actions" section, I want a "Save File Selection Changes" button, with a tooltip explaining it will "Save any local additions, deletions, or modifications to the file selection list."
    *   This button should be enabled only if I have made local changes to the list and no other review action is processing.
    *   When I click it:
        *   If there are no local changes to save, I want a notification "No changes to save."
        *   Otherwise, I want to see a visual indicator that changes are being saved.
        *   Upon success, I want a notification "File selection changes saved successfully."
        *   If there's an error saving, I want an error notification.
14. **Resetting the Selection to its Original State:**
    *   In the "Final Actions" section, I want a "Reset Selection" button, with a tooltip explaining it will "Revert file selection to the original AI-generated list for this review cycle. Manual changes will be lost."
    *   This button should be disabled if another review action is processing.
    *   When I click it:
        *   I want to be asked for confirmation (e.g., "Are you sure you want to reset?").
        *   If I confirm, I want the system to begin resetting the list to its last AI-provided state for this review cycle, and I expect to see the list update accordingly.
15. **Choosing the Number of Design Variations:**
    *   In the "Final Actions" section, I want a dropdown menu labeled "Design Variations" (or similar), with a tooltip explaining it's to "Select the number of design proposals the AI should generate."
    *   I want to be able to select a predefined number of variations (e.g., 1, 2, or 3).
16. **Approving the Selection and Triggering Design Generation:**
    *   In the "Final Actions" section, I want an "Approve Selection & Generate Design" button.
    *   This button should be disabled if my current selection list is empty or if another review action is processing.
    *   When I click it:
        *   If my selection list is empty, I want a notification "Cannot approve an empty file selection."
        *   Otherwise, I want the system to first automatically save any unsaved local changes I've made to the list.
        *   Then, I want to see a visual indicator that the approval and design generation process has started.
        *   I want a notification like "Design generation started."
        *   If there's an error during this process, I want an error notification.
17. **Disabling Actions During Processing:**
    *   During any of the review actions that involve server communication (Submit Instructions, Save, Reset, Approve), I want other action buttons within the "Refine..." and "Final Actions" sections to be temporarily disabled to prevent concurrent operations.
